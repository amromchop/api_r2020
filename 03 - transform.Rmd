---
title: "Transform Data"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

## Exercise 1

```{r setup}
library(tidyverse)  # Provides functions used throughout this session
library(readxl) # Provides function for reading in excel workbooks
orders <- read_excel("data/orders_data_set.xlsx")
```

## Orders

```{r}
orders
```

```{r}
summary(orders)
```


## Select

```{r}
select(orders, description, department)
select(orders, c(1,4))
```

## Exercise 2

Alter the code to select just the `order_status_c` column:

```{r}
select(orders, description, department)
```

## Consider

Which of these is NOT a way to remove the columns that represent status codes?

```{r}
select(orders, -ends_with("_c"))
select(orders, -c(lab_status_c, order_status_c, reason_for_canc_c))
select(orders, -c(6,8,10))
select(orders, -contains("status"))
```

## Filter

```{r}
filter(orders, patient_id == 508061)
```

```{r}
filter(orders, proc_code == "BMP")
```

## Exercise 3

Use the 3 code blocks below and `filter()` to show how you would filter the `orders` dataset.

First modify the code in this block to find:

* Every order_id that is greater than 100000
```{r}
filter(orders, proc_code == "BMP")
```

After modifying the code above, copy and paste it into the next two code blocks, and alter it to show:

* All of the orders where lab_status_c_descr is equal to “Final result”
```{r}

```

* All of the orders where reason_for_canc_c_descr is not NA 
```{r}

```

## Exercise 4

Modify the code block below and use Boolean operators with `filter()` to identify the rows in the `orders` dataset that fulfill the following conditional statements: 

* Orders for patient number 510909 with proc_code TSH 

* Orders for tests that were canceled and originally chosen from a preference list (HINT: These are coded in the pref_list_type column as either "Clinic Preference List" or "Provider Preference List")

* Orders for one of the following departments: OB GYN CLINIC, GERIATRIC CLINIC, or PEDIATRIC CLINICS

NOTE: Use the following code block as a template for the first filter() statement. For each of the remaining two, either copy paste a new code block, or use the CTRL-ALT-I keyboard shortcut to make a new code block. Use the new code blocks for the next two filter() statements.

```{r}
filter(orders, proc_code == "BMP")
```


## Arrange

```{r}
arrange(orders, patient_id)
```

## Exercise 5

Modify the code below to arrange orders by `order_status_c_descr`. What order statuses appear in the top rows of the data frame?

Now in a new code chunk add `order_class_c_descr` as a second (tie breaking) variable to arrange on, but order it in reverse alphabetical order. Explore what type of order class appears in the first rows of the data frame. Based on the description column, to what type of lab test does this order class seem to relate to?

```{r}
arrange(orders, patient_id)
```


## Steps and the pipe

```{r}
VITD <- orders %>%
		 filter(description == "1,25 DIHYDROXY VITAMIN D") %>%
		 select(department, ordering_route, pref_list_type) %>%
		 arrange(department)
VITD
```

## Exercise 6

Use `%>%` to write a sequence of functions that: 

1. Filters to orders coming from the department "BEHAVIORAL HEALTH CLINIC" (case-sensitive)
2. Selects the `description`, `ordering_route`, and `pref_list_type` columns  
3. Arrange the dataset by the `description` and `ordering_route` column.

Using <-, assign the result to a new variable (name it whatever you like).

Use your mouse to select the name of the new data frame from the list of data sets in the upper-right pane of Rstudio. Do you notice any ordering patterns?

```{r}
orders %>% 
  filter(department =='BEHAVIORAL HEALTH CLINIC') %>% 
  select(description,pref_list_type, ordering_route) %>% 
  arrange(description,ordering_route)
```


## mutate

```{r}
orders %>%
	mutate(coded_order_id = order_id/2) %>% select(coded_order_id)
```

## Exercise 7

The weekdays() function will return the weekday for any date.

1. Use the weekdays() function to make a new column which contains the day of the week that each order was placed.
2. Then select this new column and the order_time column.


```{r}

```


Replace a column with `mutate()`
```{r}
orders %>%
	mutate(pref_list_type = 
	         pref_list_type %in% c("Clinic Preference List", 
	                               "Provider Preference List")) 
```

Conditionally replace values in a column with `mutate()`
```{r}
orders %>%
	mutate(proc_code = ifelse(proc_code %in% c("CBC","CBD"), 
	                          "CBC", 
	                          proc_code)) 
```


## Summarize

```{r}
orders %>%
	summarize(order_count = n(),      
              pt_count = n_distinct(patient_id)) 
```

## Exercise 8

Start by adding a new code block here (copy/paste above or CTRL-ALT-I).

Then add on to the code in the previous code block to determine the average number of orders per patient *and per department*.







## Exercise 9

Start by adding a new code block here (copy/paste above or CTRL-ALT-I).

Use summarize() to calculate the date of the first (minimum) order and last (maximum) result in the orders data frame







## Your Turn 10

Extract the rows where `name == "Khaleesi"`. Then use `summarise()` and a summary functions to find:

1. The total number of children named Khaleesi
2. The first year Khaleesi appeared in the data

```{r}

```

## Toy data for transforming

```{r}
# Toy dataset to use
pollution <- tribble(
       ~city,   ~size, ~amount, 
  "New York", "large",      23,
  "New York", "small",      14,
    "London", "large",      22,
    "London", "small",      16,
   "Beijing", "large",      121,
   "Beijing", "small",      56
)
```

## Summarize

```{r}
pollution %>% 
 summarise(mean = mean(amount), sum = sum(amount), n = n())
```

```{r}
pollution %>% 
  group_by(city) %>%
  summarise(mean = mean(amount), sum = sum(amount), n = n())
```


## Your Turn 11

Use `group_by()`, `summarise()`, and `arrange()` to display the ten most popular baby names. Compute popularity as the total number of children of a single gender given a name.

```{r}

```

## Your Turn 12

Use grouping to calculate and then plot the number of children born each year over time.

```{r}

```

## Ungroup

```{r}
orders %>%
  group_by(name, sex) %>% 
  summarise(total = sum(n)) %>% 
  arrange(desc(total))
```

## Mutate

```{r}
orders %>%
  mutate(percent = round(prop*100, 2))
```

## Your Turn 13

Use `min_rank()` and `mutate()` to rank each row in `orders` from largest `n` to lowest `n`.

```{r}

```

## Your Turn 14

Compute each name's rank _within its year and sex_. 
Then compute the median rank _for each combination of name and sex_, and arrange the results from highest median rank to lowest.

```{r}

```

## Flights data
```{r}
flights
skim(flights)
```

## Toy data

```{r}
band <- tribble(
   ~name,     ~band,
  "Mick",  "Stones",
  "John", "Beatles",
  "Paul", "Beatles"
)

instrument <- tribble(
    ~name,   ~plays,
   "John", "guitar",
   "Paul",   "bass",
  "Keith", "guitar"
)

instrument2 <- tribble(
    ~artist,   ~plays,
   "John", "guitar",
   "Paul",   "bass",
  "Keith", "guitar"
)
```

## Mutating joins

```{r}
band %>% left_join(instrument, by = "name")
```

## Your Turn 15

Which airlines had the largest arrival delays? Complete the code below.

1. Join `airlines` to `flights`
2. Compute and order the average arrival delays by airline. Display full names, no codes.

```{r}
flights %>%
  drop_na(arr_delay) %>%
                      %>%
  group_by(         ) %>%
                      %>%
  arrange(       ) 
```

## Different names

```{r}
band %>% left_join(instrument2, by = c("name" = "artist"))
```

## Your Turn 16

How many airports in `airports` are serviced by flights originating in New York (i.e. flights in our dataset?) Notice that the column to join on is named `faa` in the **airports** data set and `dest` in the **flights** data set.


```{r}
__________ %>%
 _________(_________, by = ___________) %>%
  distinct(faa)
```



***

# Take aways

* Extract variables with `select()`  
* Extract cases with `filter()`  
* Arrange cases, with `arrange()`  

* Make tables of summaries with `summarise()`  
* Make new variables, with `mutate()`  
* Do groupwise operations with `group_by()`

* Connect operations with `%>%`  

* Use `left_join()`, `right_join()`, `full_join()`, or `inner_join()` to join datasets
* Use `semi_join()` or `anti_join()` to filter datasets against each other




## Joining data

```{r}
library(nycflights13)
```

## Your turn
Read in the toy datasets band and instrument


## Types of joins

```{r}
band %>% left_join(instrument, by = "name")
band %>% right_join(instrument, by = "name")
band %>% full_join(instrument, by = "name")
band %>% inner_join(instrument, by = "name")
```

## Your turn
Which airlines had the largest arrival delays? Work in groups to complete the code below. 

```{r}
flights %>%
  drop_na(arr_delay) %>%
     #something!     %>%
  group_by(   #something!  ) %>%
     #something!      %>%
  arrange(  #something! )       
```

## Your turn
Read in the toy dataset instrument2

## What if the names don't match?

```{r}
band %>% left_join(instrument2, by = c("name" = "artist"))
```

```{r}
airports %>% left_join(flights, by = c("faa" = "dest"))
```


# Take aways

* Extract variables with `select()`  
* Extract cases with `filter()`  
* Arrange cases, with `arrange()`  

* Make tables of summaries with `summarise()`  
* Make new variables, with `mutate()`  
* Do groupwise operations with `group_by()`

* Connect operations with `%>%`  

* Use `left_join()`, `right_join()`, `full_join()`, or `inner_join()` to join datasets
* Use `semi_join()` or `anti_join()` to filter datasets against each other


