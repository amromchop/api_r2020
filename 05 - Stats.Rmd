---
title: "Statistical Analysis in R"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

## Setup

```{r setup}
library(tidyverse)  # Provides functions used throughout this session
library(magrittr)   # %<>%
library(patchwork)  # Combine multiple plots together
library(broom)      # tidy statistics functions
library(yardstick)

covid_testing <- read_csv("data/covid_testing.csv")

# remove pre-pandemic testing
covid_testing <- covid_testing %>%
  filter(pan_day >= 0)
```

## Summarize

### How many tests are performed per day?
```{r}
ggplot(data = covid_testing) +
  geom_histogram(aes(x = pan_day), binwidth = 1)
```


```{r}
covid_testing %>%
  select(mrn, pan_day) %>%
  head(4) %>%
	summarize(order_count = n(),
	          day_count    = n_distinct(pan_day)) 
```

## Your Turn 1

Add onto the code in the above chunk to calculate the items for a and b below.

*Hints:* 

- Start by adding a new code block under each item (copy/paste above or CTRL-ALT-I).
- Then copy code from the previous code block and edit to determine the mean number of orders per patient. 
- Next, add code to calculate the mean count of orders per department. 
- Assign the results to new objects, orders_1a and orders_1b.

a) Mean count of orders per `pan_day`
 
```{r, eval=FALSE}

```
 
```{r}
# solution
stats_1a <- covid_testing %>%
	summarize(order_count = n(),
	          day_count = n_distinct(pan_day),
	          order_count_mean = n() / n_distinct(pan_day))
stats_1a
```

b) Mean count of orders per clinic

```{r, eval=FALSE}

```

```{r}
# solution
stats_1b <- covid_testing %>%
	summarize(order_count = n(),
	          clinic_count = n_distinct(clinic_name),
	          order_count_mean = order_count / clinic_count)
stats_1b
```

## Summarize examples

### Last pandemic day (in data)
```{r, eval=FALSE}
covid_testing %>%
  summarize(last_day = ____(pan_day))
  
```

```{r}
# solution
covid_testing %>%
  summarize(last_day = last(pan_day))
```

### Median turnaround time
```{r, eval=FALSE}
covid_testing %>%
  mutate(col_ver_tat = col_rec_tat ___ rec_ver_tat) %>%
  summarize(col_ver_tat_mean = mean(col_ver_tat),
            col_ver_tat_median = ______(col_ver_tat))
```

```{r}
# solution
covid_testing %>%
  mutate(col_ver_tat = col_rec_tat + rec_ver_tat) %>%
  summarize(col_ver_tat_mean = mean(col_ver_tat),
            col_ver_tat_median = median(col_ver_tat))
```

## group_by

```{r}
covid_testing %>% 
  group_by(pan_day)
```

## group_by %>% summarize

```{r}
covid_testing %>%
	group_by(pan_day) %>%
	summarize(order_count = n())
```

## Your Turn 3

a) Calculate the median turnaround time for each day

```{r, eval=FALSE}
covid_testing %>%
  mutate(col_ver_tat = ________________) %>%
  group_by(______) %>%
  summarize(col_ver_tat_median = ___________)
```

```{r}
# solution
covid_testing %>%
  mutate(col_ver_tat = col_rec_tat + rec_ver_tat) %>%
  group_by(pan_day) %>%
  summarize(col_ver_tat_median = median(col_ver_tat))
```

b) (*Extra*) The median number of orders per day

```{r, eval=FALSE}
covid_testing %>%
  group_by(_________) %>%
  summarize(n_orders = __________) %>%
  summarize(n_orders_median = _____________)
```

```{r}
# solution
covid_testing %>%
  group_by(pan_day) %>%
  summarize(n_orders = n()) %>%
  summarize(n_orders_median = median(n_orders))
```

## Group_by %>% Summarize examples

### Number of tests per day by group

```{r, eval=FALSE}
# TODO replace
tmp <- covid_testing %>%
  group_by(pan_day) %>%
  summarize(n_tests = n(),
            n_pos = ___________________,
            p_pos = _______ / n_tests * 100)

g1 <- ggplot(data = tmp) +
  geom_point(aes(x = ______, y = _____)) +
  geom_smooth(aes(x = _______, y = ______), method = 'loess') +
  ylab("% Positive") +
  xlab("Pandemic day")
g1

g2 <- ggplot(data = tmp) +
  geom_point(aes(x = _______, y = ______)) +
  geom_smooth(aes(x = _______, y = _______), method = 'loess') +
  ylab("# Positive") +
  xlab("Pandemic day")
g2

g1 / g2
```

```{r}
# solution
tmp <- covid_testing %>%
  group_by(pan_day) %>%
  summarize(n_tests = n(),
            n_pos = sum(result == 'positive'),
            p_pos = n_pos / n_tests * 100)

g1 <- ggplot(data = tmp) +
  geom_point(aes(x = pan_day, y = p_pos)) +
  geom_smooth(aes(x = pan_day, y = p_pos), method = 'loess') +
  ylab("% Positive") +
  xlab("Pandemic day")
g1

g2 <- ggplot(data = tmp) +
  geom_point(aes(x = pan_day, y = n_pos)) +
  geom_smooth(aes(x = pan_day, y = n_pos), method = 'loess') +
  ylab("# Positive") +
  xlab("Pandemic day")
g2

g1 / g2
```

## Association testing

TODO Plan
- Walk through the remapping together
- Walk through evidence for association -- Fisher.test
- Your Turn: government VS commercial [2x2]; what is the p-value? what is the odds ratio? what is the confidence interval

### payor_group
```{r}
covid_testing %>%
  count(payor_group)

tmp <- covid_testing %>%
  mutate(payor_group_fac = case_when(
                              is.na(payor_group)                                                            ~ "unassigned",
                              payor_group %in% c("charity care", "medical assistance", "self pay", "other") ~ "other",
                                                                                                      TRUE ~ payor_group)
  ) %>%
  filter(result %in% c("positive", "negative"))

tmp %>%
  count(payor_group_fac)

# Hypergeometric test
tmp %>% 
  count(payor_group_fac, result) %>%
  spread(key = "result", value = "n") %>%
  select(-payor_group_fac) %>%
  fisher.test(simulate.p.value = T)

# Your turn
tmp %>% 
  count(payor_group_fac, result) %>%
  filter(payor_group_fac %in% c("commercial", "government")) %>%
  spread(key = "result", value = "n") %>%
  select(-payor_group_fac) %>%
  fisher.test()


```

Demo logistic regression. Need to clean up and simplify

```{r, eval=FALSE}
tmp <- covid_testing %>%
  mutate(payor_group_fac = case_when(
                              is.na(payor_group)                                                            ~ "unassigned",
                              payor_group %in% c("charity care", "medical assistance", "self pay", "other") ~ "other",
                                                                                                      TRUE ~ payor_group)
  ) %>%
  filter(result %in% c("positive", "negative"))

tmp %<>%
  mutate(result_fac = factor(result, levels=c("negative", "positive"), ordered=T),
         gender = factor(gender, levels = c("female", "male")),
         payor_group_fac = (payor_group == "commercial"))

tmp_fit <- tmp %>%
  glm(result_fac ~ gender + payor_group_fac + age,
      data=., 
      family="binomial"
  )

tidy(tmp_fit)

add_pr


```

